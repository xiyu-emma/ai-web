<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <title>Labeling - {{ upload.original_filename }}</title>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 2em; 
            background-color: #f8f9fa; 
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h2 { text-align: center; color: #333; }
        .button-container { 
            text-align: center; 
            margin: 20px 0; 
        }
        .action-button { 
            display: inline-block; 
            padding: 10px 20px; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            font-size: 16px; 
            margin: 0 10px; 
            border: none; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .grid-item {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background: #fafafa;
            text-align: center;
        }
        .grid-item img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .grid-item select {
            width: 100%;
            margin-top: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin-top: 2em;
        }
        .pagination li { margin: 0 5px; }
        .pagination a, .pagination span {
            display: block;
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-decoration: none;
            color: #007bff;
        }
        .pagination .active a { background-color: #007bff; color: white; }
        .pagination .disabled span { color: #6c757d; background-color: #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Labeling Page</h2>
        <p><strong>File:</strong> {{ upload.original_filename }}</p>
        <p><strong>Total Items:</strong> {{ pagination.total }}</p>

        <div class="button-container">
            <a href="{{ url_for('main.results', upload_id=upload.id) }}" class="action-button btn-secondary">Back to Results</a>
            <button onclick="saveAllLabels()" class="action-button btn-primary">Save All Labels</button>
            <a href="{{ url_for('main.export_csv', upload_id=upload.id) }}" class="action-button btn-info">Download CSV</a>
        </div>

        <div class="grid-container" id="labelGrid">
            {% for item in pagination.items %}
            <div class="grid-item">
                <img src="{{ url_for('static', filename=item.spectrogram_url) }}" alt="Spectrogram">
                <select class="label-select" data-result-id="{{ item.id }}">
                    <option value="">-- Select Label --</option>
                    {% for label in [] %}
                    <option value="{{ label.id }}" {{ 'selected' if item.label_id == label.id else '' }}>
                        {{ label.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
        </div>

        <nav>
            <ul class="pagination">
                <li class="{{ 'disabled' if not pagination.has_prev else '' }}">
                    <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=1) }}">&laquo;&laquo;</a>
                </li>
                <li class="{{ 'disabled' if not pagination.has_prev else '' }}">
                    <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=pagination.prev_num) }}">&laquo;</a>
                </li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="{{ 'active' if page_num == pagination.page else '' }}">
                            <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="disabled"><span>...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="{{ 'disabled' if not pagination.has_next else '' }}">
                    <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=pagination.next_num) }}">&raquo;</a>
                </li>
                <li class="{{ 'disabled' if not pagination.has_next else '' }}">
                    <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=pagination.pages) }}">&raquo;&raquo;</a>
                </li>
            </ul>
        </nav>
    </div>

    <script>
        let labels = [];

        async function loadLabels() {
            try {
                const response = await fetch('/api/labels');
                labels = await response.json();
                updateLabelSelects();
            } catch (error) {
                console.error('Error loading labels:', error);
            }
        }

        function updateLabelSelects() {
            const selects = document.querySelectorAll('.label-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Label --</option>';
                labels.forEach(label => {
                    const option = document.createElement('option');
                    option.value = label.id;
                    option.textContent = label.name;
                    if (label.id == currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        async function saveAllLabels() {
            const selects = document.querySelectorAll('.label-select');
            let savedCount = 0;
            
            for (const select of selects) {
                const resultId = select.getAttribute('data-result-id');
                const labelId = select.value ? parseInt(select.value) : null;
                
                try {
                    await fetch(`/api/results/${resultId}/label`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ label_id: labelId })
                    });
                    savedCount++;
                } catch (error) {
                    console.error(`Error saving label for result ${resultId}:`, error);
                }
            }
            
            alert(`Saved ${savedCount} labels successfully!`);
        }

        loadLabels();
    </script>
</body>
</html>
